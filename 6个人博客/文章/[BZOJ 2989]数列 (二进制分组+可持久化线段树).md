## [BZOJ 2989]数列 (二进制分组+可持久化线段树)

### 题面

给定一个长度为n的正整数数列a[i]。

定义2个位置的graze值为两者位置差与数值差的和，即graze(x,y)=|x-y|+|a[x]-a[y]|。

2种操作（k都是正整数）：

1.Modify x k：将第x个数的值修改为k。

2.Query x k：询问有几个i满足graze(x,i)<=k。因为可持久化数据结构的流行，询问仅要考虑当前数列，还要考虑任意历史版本，即统计任意位置上出现过的任意数值与当前的a[x]的graze值<=k的对数。（某位置多次修改为同样的数值，按多次统计）

### 分析

据说正解是二进制分组+主席树？

观察到$|x-y|+|a[x]-a[y]|$,我们想到曼哈顿距离。于是我们把(x,a[x])看作一个二维平面上的点，而查询的是到平面上一定点距离<=k的点的个数。同时这样还避免了可持久化的问题，因为把a[x]修改成k，相当于新建了一个点。

到平面上一定点曼哈顿距离=k的点的集合（曼哈顿距离下的圆）是一个斜45°，边长为$\frac{\sqrt{2}}{2}k$的正方形。我们求的答案就是这个正方形里的点的个数

![](https://i.loli.net/2018/09/12/5b985842e76d4.png)

[图片转载自https://www.cnblogs.com/SGCollin/p/9636955.html]

这样的点距离不太好求。但是我们知道切比雪夫距离下的圆是一个四边都平行坐标轴的正方形。因此我们可以把曼哈顿距离转成对应的切比雪夫距离。注：$(x_1,y_1)和(x_2,y_2)的切比雪夫距离是max(|x_1-x_2|,|y_1-y_2|)$

![](https://i.loli.net/2018/09/12/5b985e0cf0f9b.png)

考虑把两个点转化成$(x_1+y_1,x_1-y_1),(x_2+y_2,x_2-y_2)$,容易发现新点的切比雪夫距离和原来点的曼哈顿距离相同.

那么我们只要把询问和修改的每个点都转成(x+y,x-y)的形式，然后问题就变成在把原来查询的正方形转换后新的正方形里点的个数。

